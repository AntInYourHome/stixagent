# STIX ID Management Tools

This directory contains tools for managing STIX 2.1 object IDs.

## Overview

According to the STIX 2.1 specification, all object IDs must follow the format:
```
{object-type}--{uuid}
```

Where:
- `{object-type}` is the STIX object type (e.g., `threat-actor`, `malware`, `relationship`)
- `{uuid}` is a valid UUID v4 (RFC 4122 compliant)

## Tools

### 1. fix_stix_ids.py

Automatically fixes invalid STIX IDs in JSON files by replacing them with properly formatted UUIDs.

**Features:**
- Generates valid UUID v4 for each object
- Maintains ID mapping to update all references
- Preserves relationship integrity (source_ref, target_ref, etc.)
- Creates backup with `_fixed` suffix

**Usage:**
```bash
# Basic usage
python tools/fix_stix_ids.py <input_file> [output_file]

# Example
python tools/fix_stix_ids.py outputs/o1.json outputs/o1_fixed.json

# Show ID mapping (verbose mode)
python tools/fix_stix_ids.py outputs/o1.json outputs/o1_fixed.json -v
```

**Python API:**
```python
from tools.fix_stix_ids import STIXIDFixer

fixer = STIXIDFixer()
fixer.fix_file('input.json', 'output.json')
print(f"Fixed {len(fixer.id_mapping)} IDs")
```

### 2. validate_stix_ids.py

Validates that all IDs in a STIX JSON file conform to the STIX 2.1 specification.

**Features:**
- Validates ID format (`{type}--{uuid}`)
- Checks UUID validity (hex characters only)
- Verifies type consistency
- Validates all ID references
- Provides detailed error reports

**Usage:**
```bash
# Validate a STIX file
python tools/validate_stix_ids.py <json_file>

# Example
python tools/validate_stix_ids.py outputs/o1_fixed.json
```

**Output:**
```
======================================================================
STIX ID Validation Report
======================================================================

Total objects: 116
Valid IDs: 116
Invalid IDs: 0

[OK] No errors found!

======================================================================
[PASS] All IDs are valid!
======================================================================
```

### 3. run_fix_ids.py

Convenience wrapper script for fixing IDs in the default output location.

**Usage:**
```bash
python tools/run_fix_ids.py
```

This automatically processes `outputs/o1.json` and creates `outputs/o1_fixed.json`.

## STIX 2.1 ID Examples

### Valid IDs
```json
{
  "type": "threat-actor",
  "id": "threat-actor--b1d4f6a8-9c2e-4d7b-8a1f-2e6d8f9b3c2d"
}
```

```json
{
  "type": "malware",
  "id": "malware--6f0653cc-c8c0-4809-81c7-676b45c7b77d"
}
```

```json
{
  "type": "relationship",
  "id": "relationship--fef23971-4df3-4fc0-95a2-1a4b7ede1863",
  "source_ref": "threat-actor--b1d4f6a8-9c2e-4d7b-8a1f-2e6d8f9b3c2d",
  "target_ref": "malware--6f0653cc-c8c0-4809-81c7-676b45c7b77d"
}
```

### Invalid IDs (Examples)
```json
// Invalid: contains non-hex characters (g, h, etc.)
"id": "malware--g6i9k1f3-e5j7-9i2g-df6k-7j1i3e8h9j7i"

// Invalid: wrong format
"id": "malware-12345"

// Invalid: type mismatch
{
  "type": "malware",
  "id": "threat-actor--b1d4f6a8-9c2e-4d7b-8a1f-2e6d8f9b3c2d"
}
```

## Integration with OpenCTI

These tools generate STIX IDs that are compatible with OpenCTI's deterministic ID generation mechanism. While OpenCTI uses "ID Contributing Properties" to generate IDs based on object characteristics, the UUIDs generated by these tools are valid and will work correctly when imported.

## STIX Object Types

Common STIX object types that require proper IDs:

**STIX Domain Objects (SDO):**
- `attack-pattern`
- `campaign`
- `course-of-action`
- `identity`
- `indicator`
- `intrusion-set`
- `malware`
- `observed-data`
- `report`
- `threat-actor`
- `tool`
- `vulnerability`

**STIX Relationship Objects (SRO):**
- `relationship`
- `sighting`

**STIX Cyber Observable Objects (SCO):**
- `artifact`
- `autonomous-system`
- `directory`
- `domain-name`
- `email-addr`
- `file`
- `ipv4-addr`
- `ipv6-addr`
- `mac-addr`
- `network-traffic`
- `process`
- `software`
- `url`
- `user-account`
- `windows-registry-key`
- `x509-certificate`

**Infrastructure & Location:**
- `infrastructure`
- `location`

## Troubleshooting

### Issue: "Invalid UUID" errors
**Solution:** The UUID part of the ID must only contain hexadecimal characters (0-9, a-f) and hyphens. Use `fix_stix_ids.py` to automatically fix these.

### Issue: Reference errors in OpenCTI
**Solution:** Ensure all `source_ref`, `target_ref`, and other reference fields point to valid IDs that exist in the bundle.

### Issue: Type mismatch
**Solution:** The type prefix in the ID must match the `type` field of the object.

## Development

To add new validation rules:

1. Edit `validate_stix_ids.py`
2. Add new validation methods to `STIXIDValidator` class
3. Update `validate_object()` or `validate_bundle()` to call new methods

To modify ID generation:

1. Edit `fix_stix_ids.py`
2. Modify `generate_valid_uuid()` or `create_new_id()` methods
3. Ensure compatibility with STIX 2.1 specification

## References

- [STIX 2.1 Specification](https://docs.oasis-open.org/cti/stix/v2.1/stix-v2.1.html)
- [RFC 4122: UUID Format](https://tools.ietf.org/html/rfc4122)
- [OpenCTI Documentation](https://www.opencti.io/)

## License

Part of the STIX Agent project.
